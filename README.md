
# BioSense‑UNO — мультимодальный съём биосигналов (ECG/PPG/Resp/EMG)

**Кратко:** прототип на Arduino UNO, который снимает **ЭКГ**, **ФПГ (PPG)**, **дыхание (термодатчик)** и **ЭМГ**, фильтрует сигнал и выводит его в **Serial Plotter**. Управление — одной клавишей режима в Serial Monitor/Plotter: `e/p/r/m`.

---

## 1) Чем хорош проект (научно и по делу)

### 1.1 Мультимодальность и синергия
- Мы измеряем **несколько физиологических каналов одновременно**: электрическая активность сердца (**ECG**), фотоплетизмограмма (**PPG**), дыхание по температуре (**Resp**), электрическая активность мышц (**EMG**).
- Каналы **дополняют друг друга**:  
  - **ECG** → точный сердечный ритм (R‑пики, 0.5–40 Гц).  
  - **PPG** → пульс, вариабельность и оценка периферической перфузии (0.5–5 Гц).  
  - **Resp** → дыхательный цикл (0.1–0.5 Гц).  
  - **EMG** → активация мышц (20–500 Гц).  
- **Совместный анализ** повышает устойчивость к артефактам и даёт больше наблюдаемых маркеров (например, дыхательная модуляция амплитуды PPG, дыхательная синусовая аритмия на ECG).

### 1.2 Обоснованный выбор частот дискретизации
- Выборки сделаны **по теореме Найквиста** с запасом под рабочий спектр канала:  
  - ECG/PPG/Resp — **100 Гц** (достаточно для 0.1–40 Гц после фильтрации).  
  - EMG — **500 Гц** (захватывает до ~250 Гц огибающей, что достаточно для детекции активации мышц).  
- Это даёт баланс: **низкая задержка, достаточное разрешение и стабильный вывод** в реальном времени даже на 16‑МГц AVR.

### 1.3 Обоснованный стек фильтрации (легковесно, но эффективно)
- **Median‑3**: подавляет одиночные выбросы/щелчки без сдвига фазы.  
- **Удаление DC** (медленный адаптивный базис, `α≈0.01`): компенсирует дрейф оптики (PPG) и неровности контакта.  
- **EMA** (экспоненциальное скользящее среднее): сглаживает шум, оставляя динамику.  
- **EMG**: выпрямление + EMA → **огибающая**, которая хорошо отражает силу сокращения.  
- Все фильтры — **O(1)** на сэмпл, что важно для UNO (2 КБ RAM).

### 1.4 Инженерная устойчивость
- **115200 бод** → ровный график без «ступенек» в Plotter.  
- Формат вывода — **только число** (одна строка — один сэмпл) → максимальная совместимость.  
- Рекомендации по железу: развязка **0.1 µF + 10 µF** на каждом модуле, «звезда» по GND, короткие проводники, RC‑фильтр на дыхании (опционально).

### 1.5 Реплицируемость и расширяемость
- БОМ из общедоступных модулей (AD8232, KY‑039, KY‑013).  
- Код без «магии» и тяжелых библиотек — легко портировать на **STM32/ESP32** (DMA/ADC/Wi‑Fi BLE стрим).  
- Структура режима позволяет добавить **алгоритмы HR/BR/SpO₂** и простые **ML‑классификаторы** для детекции событий.

---

## 2) Архитектура и принцип работы

```
AD8232 ─┐
        ├─> A0 ─┐               ┌─────[Median3]─[DC‑remove]─[EMA]────► UART 115200 ► ПК/Serial Plotter
KY‑039 ─┤       ├─> MUX by mode ┤
        │       │               └───── (EMG: Rectify+EMA → Envelope)
KY‑013 ─┘       └─> таймер по режиму (100 Гц / 500 Гц)
```

- **MCU**: ATmega328P (Arduino UNO).  
- **Периферия**: ADC 10‑бит, polling (без прерываний/таймеров для простоты).  
- **Режимы**: `e` (ECG), `p` (PPG), `r` (Resp), `m` (EMG).  
- **Вывод**: одна строка — один сэмпл активного канала (0…1023).

---

## 3) Принципиальная схема (соединения)

Общий GND, питание 5 V. Для KY‑013 **средний пин — сигнал (S)**, крайние — +5V/GND.

| Модуль | Сигнал на модуле | Куда на Arduino |
|---|---|---|
| **AD8232** (ECG/EMG) | OUTPUT | **A0** |
|  | LO− | **D2** |
|  | LO+ | **D3** |
|  | 5V / GND | 5V / GND |
| **KY‑039** (PPG) | S | **A1** |
|  | + / − | 5V / GND |
| **KY‑013** (Resp) | **S (центр)** | **A2** |
|  | + / − (края) | 5V / GND |

**Антишум по питанию:** 0.1 µF (керамика) + 10 µF (электролит) на каждом модуле (между VCC и GND).  
**RC для Resp (опц.)**: последовательно 10 kΩ в линию A2 + 10 µF на GND у A2 (fc ≈ 1.6 Гц).

---

## 4) Список компонентов (BOM)

- Arduino UNO (ATmega328P) — 1 шт  
- AD8232 модуль — 1 шт (электроды/провода 3 шт)  
- KY‑039 (PPG) — 1 шт  
- KY‑013 (терморезистор) — 1 шт  
- Конденсаторы 0.1 µF ×3, 10 µF ×3 — 6 шт  
- (Опц.) Резистор 10 kΩ ×1, конденсатор 10 µF ×1 (RC на Resp)  
- Макетная плата, провода dupont  
- Источник 5 V (желательно power‑bank)

---

## 5) Прошивка и протокол вывода

- **Скорость порта:** 115200 бод.  
- **Формат:** *только* число 0…1023 на строку (совместимо с Serial Plotter).  
- **Переключение режимов:** отправить символ `e` / `p` / `r` / `m` в порт.  
- **Частоты:** ECG/PPG/Resp — 100 Гц; EMG — 500 Гц.

### Псевдокод фильтрации
- `median3(x[n], x[n-1], x[n-2])` — борется с выбросами.  
- `base ← (1–α)*base + α*x` — удаление DC‑дрейфа (α≈0.01).  
- `EMA ← (1–β)*EMA + β*(x–base)` — сглаживание (β подбирается под канал).  
- EMG: `env ← EMA(|x–base|)` — огибающая активации мышц.

---

## 6) Метрические цели и валидация (как защищаться «научно»)

**Цели MVP:**
- **HR (уд./мин)** из ECG и PPG: рассчитать по расстоянию между пиками (локальные максимумы, порог/рефрактерный интервал 250–300 мс).  
- **BR (вдохов/мин)** из Resp (KY‑013): по периодичности сглаженной волны.  
- **EMG level**: средняя огибающая при статическом удержании.

**Пример плана валидации:**
1. Записать 60 секунд в каждом режиме на здоровом испытуемом (питание от power‑bank).  
2. Сравнить HR(ECG) и HR(PPG): **|ΔHR| ≤ 5 уд./мин** в покое.  
3. Сравнить BR(Resp) со счётом вдохов вручную: **|ΔBR| ≤ 2 вдоха/мин**.  
4. EMG: рост огибающей **> 3×** относительно покоя при изометрическом сжатии.

Метрики: среднее отклонение, **RMSE**, коэффициент корреляции **r**, диаграмма Бланда–Алтмана (опционально).

---

## 7) Ограничения и безопасность

- Прототип **не медицинский**, не для диагностики.  
- Не подключать испытуемого к сети 220 В через ПК/адаптеры без гальваноразвязки; предпочтительно питание от батареи.  
- AD8232 рассчитан на ЭКГ; ЭМГ тут — «режим совместимости»: для научной точности нужен специализированный фронт‑энд (INA128/AD620 с полосой 20–500 Гц).

---

## 8) Как оформить схему/плату (31×26 мм) и показать подключение

- **Fritzing** — красивая breadboard‑схема для README (Arduino + три модуля, цветные провода, экспорт PNG/SVG).  
- **EasyEDA (онлайн)** — принципиальная схема + PCB.  
  - Создайте проект → Schematic → добавьте разъёмы под модули.  
  - PCB Editor → **Design → Board Outline** → задайте **31×26 мм**.  
  - Расставьте конденсаторы рядом с каждым разъёмом, разведите «звезду» GND, короткие трассы к A0/A1/A2.  
  - Шарьте ссылку/изображение в README.  
- **Tinkercad Circuits** — онлайн‑демо подключения + шаринг проекта (подходит для визуализации, даже если модулей в библиотеке нет — используйте «Generic sensor» и подписи).

---

## 9) Быстрый старт

1) Соберите схему по таблице (см. §3).  
2) Залейте скетч **Stable Plotter Build** (из `firmware/`).  
3) Откройте **Tools → Serial Plotter**, скорость **115200**.  
4) Нажмите `e/p/r/m` и наблюдайте сигнал в активном режиме.  
5) Для отчёта — сделайте скриншоты волн в покое/при нагрузке.

---
